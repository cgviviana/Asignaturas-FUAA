  
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cuestionario — Normativa</title>
  <style>
    :root{
      --bg-overlay: rgba(255,255,255,.86);
      --card: rgba(255,255,255,.96);
      --text: #111827;
      --muted: #4b5563;
      --border: rgba(17,24,39,.14);
      --shadow: 0 10px 24px rgba(17,24,39,.10);
      --radius: 14px;

      --primary: #1d4ed8;
      --primary-2: #1e40af;

      --danger: #b91c1c;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      min-height:100vh;
      background:
        linear-gradient(180deg, rgba(255,255,255,.22), rgba(255,255,255,.50)),
        url("fondo.jpg");
      background-size: cover;
      background-position:center;
      background-attachment: fixed;
    }

    .wrap{ max-width: 980px; margin: 0 auto; padding: 22px 16px 44px; }

    .header{
      display:flex; align-items:center; justify-content:space-between; gap: 12px;
      padding: 14px 16px;
      border:1px solid var(--border);
      background: var(--bg-overlay);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .brand{ display:flex; align-items:center; gap: 12px; min-width: 220px; }
    .mark{
      width:36px;height:36px;border-radius:10px;
      background: rgba(29,78,216,.10);
      border:1px solid rgba(29,78,216,.20);
      display:grid; place-items:center;
      font-weight:900; color: var(--primary);
    }
    .brand-title{ font-weight: 800; letter-spacing:.2px; font-size: 14px; line-height: 1.2; }
    .brand-sub{ color: var(--muted); font-size: 12px; line-height: 1.2; margin-top: 2px; }

    .hud{ display:flex; align-items:center; gap: 10px; flex-wrap:wrap; justify-content:flex-end; }

    .pill{
      font-family: var(--mono);
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.92);
      color: var(--muted);
      white-space: nowrap;
    }
    .timer{
      font-family: var(--mono);
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(29,78,216,.25);
      background: rgba(239,246,255,.92);
      color: #1e3a8a;
      min-width: 130px;
      text-align:center;
    }
    .timer.danger{
      border-color: rgba(185,28,28,.25);
      background: rgba(254,242,242,.95);
      color: #7f1d1d;
    }

    .card{
      margin-top: 14px;
      padding: 18px;
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: var(--card);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    h1{ margin: 0 0 8px; font-size: 18px; }
    p{ margin: 6px 0 0; color: var(--muted); line-height: 1.5; font-size: 14px; }

    label.field{ display:block; margin: 12px 0 6px; font-size: 13px; color: var(--muted); }
    input[type="text"], input[type="password"], input[type="number"]{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.96);
      font-size: 14px;
      outline: none;
    }
    input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus{
      border-color: rgba(29,78,216,.45);
      box-shadow: 0 0 0 4px rgba(29,78,216,.12);
    }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 720px){ .row{ grid-template-columns: 1fr; } }

    .btnbar{ display:flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
    button{
      border:0;
      padding: 11px 14px;
      border-radius: 12px;
      font-weight: 800;
      cursor:pointer;
      transition: background .15s ease, transform .05s ease;
    }
    button:active{ transform: translateY(1px); }
    .btn-primary{ background: var(--primary); color:#fff; }
    .btn-primary:hover{ background: var(--primary-2); }
    .btn-ghost{ background: rgba(17,24,39,.04); border:1px solid var(--border); color: var(--text); }
    .btn-ghost:disabled, .btn-primary:disabled{ opacity:.55; cursor:not-allowed; }

    .notice{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(29,78,216,.18);
      background: rgba(239,246,255,.65);
      color: var(--text);
      font-size: 13px;
      line-height: 1.45;
    }

    .closed{
      border-color: rgba(185,28,28,.18);
      background: rgba(254,242,242,.88);
    }

    .qbox{
      margin-top: 10px;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.97);
    }
    .qmeta{
      display:flex; justify-content:space-between; align-items:center; gap: 10px;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
      margin-bottom: 10px;
    }
    .qtext{
      font-weight: 800;
      margin: 0 0 10px;
      font-size: 14px;
      line-height: 1.45;
    }
    .opts{ display:grid; gap: 10px; }

    .opt{
      display:grid;
      grid-template-columns: 22px 1fr;
      gap: 10px;
      align-items:start;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.98);
      cursor:pointer;
    }
    .opt:hover{ border-color: rgba(29,78,216,.28); }
    .opt input[type="radio"]{
      margin: 2px 0 0 0;
      width: 16px;
      height: 16px;
      justify-self:start;
      align-self:start;
    }
    .opt .opt-text{ line-height: 1.4; font-size: 14px; color: var(--text); }
    .opt .opt-letter{ font-weight: 900; margin-right: 6px; }

    .divider{ height:1px; background: rgba(17,24,39,.10); margin: 14px 0; }

    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow:hidden;
    }
    th, td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(17,24,39,.08);
      font-size: 14px;
      text-align:left;
    }
    th{
      background: rgba(17,24,39,.04);
      color: var(--muted);
      font-weight: 900;
    }

    .hidden{ display:none !important; }
    .strong{ font-weight: 900; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="mark">Q</div>
        <div>
          <div class="brand-title">Cuestionario — Normativa</div>
          <div class="brand-sub">Acceso con código · 2 intentos máx. · 6:00 min</div>
        </div>
      </div>
      <div class="hud">
        <div class="pill" id="attemptPill">Intentos: 0/2</div>
        <div class="timer hidden" id="timer">06:00</div>
      </div>
    </div>

    <div class="card" id="viewAccess">
      <h1>Ingreso</h1>
      <p>Ingresa el código de acceso para continuar.</p>
      <label class="field" for="accessCode">Código de acceso</label>
      <input id="accessCode" type="password" autocomplete="off" />
      <div class="btnbar">
        <button class="btn-primary" id="btnAccess">Continuar</button>
      </div>
    </div>

    <div class="card hidden" id="viewInfo">
      <h1>Datos del estudiante</h1>
      <p>Se registran en el resumen final.</p>
      <div class="row">
        <div>
          <label class="field" for="studentName">Nombre completo (TODO EN MAYÚSCULAS)</label>
          <input id="studentName" type="text" />
        </div>
        <div>
          <label class="field" for="studentList">Número de la lista</label>
          <input id="studentList" type="number" inputmode="numeric" />
        </div>
      </div>
      <div class="btnbar">
        <button class="btn-primary" id="btnStart">Iniciar</button>
        <button class="btn-ghost" id="btnBack">Volver</button>
      </div>
    </div>

    <div class="card hidden" id="viewQuiz">
      <h1 id="quizTitle">Intento</h1>
      <p id="quizSubtitle"></p>

      <div class="qbox">
        <div class="qmeta">
          <span id="progressText">Pregunta</span>
          <span id="qidText">—</span>
        </div>
        <div class="qtext" id="qText"></div>
        <div class="opts" id="qOptions"></div>
      </div>

      <div class="divider"></div>
      <div class="btnbar">
        <button class="btn-ghost" id="btnPrev">Anterior</button>
        <button class="btn-primary" id="btnNext">Siguiente</button>
        <button class="btn-primary hidden" id="btnFinish">Finalizar intento</button>
      </div>

      <div class="notice" id="quizFooter"></div>
    </div>

    <div class="card hidden" id="viewResults">
      <h1 id="resultsTitle">Resultados</h1>
      <div class="notice" id="resultsHeader"></div>

      <table id="resultsTable">
        <thead>
          <tr>
            <th>Intento</th>
            <th>Puntaje</th>
            <th>Duración</th>
            <th>Fecha y hora</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="divider"></div>
      <div class="btnbar" id="resultsButtons"></div>
    </div>
  </div>

<script>
(function(){
  // Hash SHA-256 del código. Evita que el código aparezca en texto plano en el archivo.
  const ACCESS_CODE_SHA256 = "f3df371458b58d32d6539b43786c39ffc0d253e9543046e67950261a934df883";

  const MAX_ATTEMPTS = 2;
  const QUIZ_SECONDS_TOTAL = 6 * 60;
  const STORAGE_KEY = "vivy_normativa_quiz_v4";

  const QUESTION_BANK = [
    {
      id: "Q1P1",
      text: "Para gestionar una excusa por inasistencia conforme a la normativa, ¿qué combinación de canal y datos mínimos es la más adecuada?",
      options: [
        { text: "Correo institucional a la docente indicando NRC, asignatura, modalidad, día de clase y asunto; y notificación en el grupo de WhatsApp de que el correo fue enviado.", correct: true },
        { text: "Registro en Drive (pestaña Notas) con soportes y comunicación general en WhatsApp indicando que quedó cargado.", correct: false },
        { text: "Mensaje en WhatsApp al grupo con soportes y posterior envío de un correo institucional solo si la docente lo solicita.", correct: false },
        { text: "Publicación en Moodle con soportes y envío de correo institucional con NRC y asignatura únicamente.", correct: false }
      ]
    },
    {
      id: "Q1P2",
      text: "De acuerdo con la normativa, ¿cuál describe mejor el uso esperado del grupo de WhatsApp del curso?",
      options: [
        { text: "Canal para avisos y comunicación general mediante mensajes en el grupo; no se contempla como canal de llamadas ni comunicación individual.", correct: true },
        { text: "Canal para resolver dudas individuales con la docente, y para coordinar retroalimentación personalizada.", correct: false },
        { text: "Canal principal para reportar entregas y justificar retrasos, dejando el correo solo para casos excepcionales.", correct: false },
        { text: "Canal de coordinación académica donde se validan reemplazos y ajustes de calificación antes de formalizarlos.", correct: false }
      ]
    },
    {
      id: "Q1P3",
      text: "Para cumplir la normativa de entrega de evidencias, ¿qué práctica es la más adecuada?",
      options: [
        { text: "Publicar las entregas en las plataformas definidas (Moodle y Drive del estudiante) dentro de las fechas establecidas.", correct: true },
        { text: "Publicar en Drive y compartir el enlace; Moodle se usa solo si la entrega es un examen.", correct: false },
        { text: "Publicar en Moodle; Drive se usa únicamente para trabajo colaborativo, no como evidencia final.", correct: false },
        { text: "Enviar por correo institucional y respaldar en Drive; la evidencia se considera válida si el correo queda registrado.", correct: false }
      ]
    },
    {
      id: "Q1P4",
      text: "Si la docente deja observaciones en un documento en Drive, ¿qué se espera del estudiante para el siguiente corte/entrega?",
      options: [
        { text: "Revisar las observaciones, corregir lo indicado y actualizar la evidencia en la siguiente entrega, verificando el avance en las pestañas de Drive Docente/Estudiante.", correct: true },
        { text: "Responder cada observación solicitando aprobación previa antes de modificar el documento, para evitar inconsistencias.", correct: false },
        { text: "Aplicar solo correcciones que afecten la nota; lo demás puede quedar para el trabajo final.", correct: false },
        { text: "Trasladar las observaciones al chat del grupo para que el subgrupo acuerde cuáles cambios son obligatorios.", correct: false }
      ]
    },
    {
      id: "Q1P5",
      text: "Respecto a reemplazos y reprogramaciones, ¿cuál afirmación es más consistente con la normativa?",
      options: [
        { text: "Los reemplazos no aplican salvo justificación validada por la universidad; en ese caso se acuerda evaluación/fecha dentro de los límites institucionales.", correct: true },
        { text: "Los reemplazos aplican si el estudiante informa al subgrupo con antelación y se evidencia avance en Drive.", correct: false },
        { text: "Los reemplazos aplican cuando el estudiante entrega una versión mejorada antes del cierre del corte, aunque esté fuera de fecha.", correct: false },
        { text: "Los reemplazos se habilitan si el estudiante presenta soportes y el subgrupo avala la reprogramación por correo.", correct: false }
      ]
    }
  ];

  const $ = (id) => document.getElementById(id);

  function nowISO(){ return new Date().toISOString(); }
  function fmtDateTime(iso){ return new Date(iso).toLocaleString(); }
  function fmtDuration(seconds){
    seconds = Math.max(0, Math.floor(seconds));
    const m = String(Math.floor(seconds/60)).padStart(2,"0");
    const s = String(seconds%60).padStart(2,"0");
    return `${m}:${s}`;
  }
  function deepCopy(obj){ return JSON.parse(JSON.stringify(obj)); }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  async function sha256Hex(text){
    const enc = new TextEncoder().encode(text);
    const hash = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,"0")).join("");
  }

  function loadState(){
    try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; }
    catch(e){ return null; }
  }
  function saveState(st){ localStorage.setItem(STORAGE_KEY, JSON.stringify(st)); }

  function defaultState(){
    return {
      closed: false,
      closedAt: null,
      accessGranted: false,
      student: { name: "", listNumber: "" },
      quiz: { startedAt: null, endsAt: null, currentAttempt: 0, attemptHistory: [] },
      runtime: null
    };
  }

  let state = loadState() || defaultState();

  const viewAccess = $("viewAccess");
  const viewInfo   = $("viewInfo");
  const viewQuiz   = $("viewQuiz");
  const viewResults= $("viewResults");

  const timerEl = $("timer");
  const attemptPill = $("attemptPill");

  let questions = [];
  let selected = {};
  let qIndex = 0;
  let attemptStartTs = null;
  let tickHandle = null;

  function showOnly(view){
    [viewAccess, viewInfo, viewQuiz, viewResults].forEach(v => v.classList.add("hidden"));
    view.classList.remove("hidden");
  }

  function setAttemptPill(){
    attemptPill.textContent = `Intentos: ${state.quiz.currentAttempt || 0}/${MAX_ATTEMPTS}`;
  }

  function startGlobalTimerIfNeeded(){
    if(state.quiz.startedAt && state.quiz.endsAt) return;
    const start = Date.now();
    state.quiz.startedAt = new Date(start).toISOString();
    state.quiz.endsAt = new Date(start + QUIZ_SECONDS_TOTAL*1000).toISOString();
    saveState(state);
  }

  function remainingGlobalSeconds(){
    if(!state.quiz.endsAt) return QUIZ_SECONDS_TOTAL;
    const end = new Date(state.quiz.endsAt).getTime();
    return Math.max(0, Math.floor((end - Date.now())/1000));
  }

  function stopTimer(){
    if(tickHandle){ clearInterval(tickHandle); tickHandle = null; }
  }

  function updateTimerUI(){
    const rem = remainingGlobalSeconds();
    timerEl.textContent = fmtDuration(rem);
    timerEl.classList.toggle("danger", rem <= 15);

    if(rem === 0){
      if(state.runtime && state.runtime.inProgress){
        finalizeAttempt(true);
      }
      closeQuiz();
    }
  }

  function startTimer(){
    timerEl.classList.remove("hidden");
    updateTimerUI();
    stopTimer();
    tickHandle = setInterval(updateTimerUI, 250);
  }

  function closeQuiz(){
    state.closed = true;
    state.closedAt = nowISO();
    state.runtime = null;
    saveState(state);
    stopTimer();
    renderClosed();
  }

  function renderClosed(){
    showOnly(viewResults);
    $("resultsTitle").textContent = "Cuestionario cerrado";
    $("resultsButtons").innerHTML = "";

    const s = state.student || {name:"", listNumber:""};
    const hist = state.quiz.attemptHistory || [];
    const last = hist.length ? hist[hist.length-1] : null;

    let header = `<div><span class="strong">Nombre:</span> <span class="strong">${escapeHtml(s.name || "-")}</span> · <span class="strong">Número de la lista:</span> ${escapeHtml(s.listNumber || "-")}</div>`;
    header += `<div style="margin-top:6px">Intentos: <span class="strong">${hist.length}/${MAX_ATTEMPTS}</span>${state.closedAt ? ` · Cierre: <span class="strong">${escapeHtml(fmtDateTime(state.closedAt))}</span>` : ""}</div>`;
    if(last){
      header += `<div style="margin-top:6px"><span class="strong">Nota válida (último intento):</span> ${last.percent}%</div>`;
    } else {
      header += `<div style="margin-top:6px">No hay intentos registrados.</div>`;
    }
    $("resultsHeader").classList.add("closed");
    $("resultsHeader").innerHTML = header;

    const tbody = $("resultsTable").querySelector("tbody");
    tbody.innerHTML = hist.length ? hist.map(r => `
      <tr>
        <td>${r.attemptNo}</td>
        <td>${r.score}/${r.total} (${r.percent}%)</td>
        <td>${fmtDuration(r.durationSec)}</td>
        <td>${escapeHtml(fmtDateTime(r.finishedAt))}</td>
      </tr>
    `).join("") : `<tr><td colspan="4">—</td></tr>`;
  }

  function buildAttemptQuestions(){
    const qs = deepCopy(QUESTION_BANK);
    shuffle(qs);
    qs.forEach(q => shuffle(q.options));
    return qs;
  }

  function persistRuntime(){
    state.runtime = {
      attemptNo: state.quiz.currentAttempt,
      questions,
      selected,
      qIndex,
      attemptStartTs,
      inProgress: true
    };
    saveState(state);
  }

  function restoreRuntime(){
    if(!state.runtime || !state.runtime.inProgress) return false;
    questions = state.runtime.questions || [];
    selected = state.runtime.selected || {};
    qIndex = state.runtime.qIndex || 0;
    attemptStartTs = state.runtime.attemptStartTs || Date.now();
    return questions.length > 0;
  }

  function scoreAttempt(){
    const total = questions.length;
    let score = 0;
    questions.forEach(q => {
      const chosen = selected[q.id];
      if(chosen === undefined) return;
      if(q.options[chosen] && q.options[chosen].correct) score += 1;
    });
    return { score, total, percent: Math.round((score/total)*100) };
  }

  function finalizeAttempt(auto=false){
    const attemptNo = state.quiz.currentAttempt;
    const endTs = Date.now();
    const durationSec = Math.max(0, Math.floor((endTs - attemptStartTs)/1000));
    const {score, total, percent} = scoreAttempt();

    state.quiz.attemptHistory.push({
      attemptNo, score, total, percent,
      startedAt: new Date(attemptStartTs).toISOString(),
      finishedAt: new Date(endTs).toISOString(),
      durationSec,
      autoSubmitted: !!auto
    });

    state.runtime = null;
    saveState(state);

    renderResults();
  }

  function startAttempt(){
    if(state.closed){ renderClosed(); return; }

    const used = (state.quiz.attemptHistory || []).length;
    if(used >= MAX_ATTEMPTS){ closeQuiz(); return; }
    if(remainingGlobalSeconds() <= 0){ closeQuiz(); return; }

    state.quiz.currentAttempt = used + 1;
    saveState(state);
    setAttemptPill();

    questions = buildAttemptQuestions();
    selected = {};
    qIndex = 0;
    attemptStartTs = Date.now();
    persistRuntime();

    renderQuestion();
    showOnly(viewQuiz);
    startTimer();
  }

  function renderQuestion(){
    const attemptNo = state.quiz.currentAttempt;
    const rem = remainingGlobalSeconds();

    $("quizTitle").textContent = `Intento ${attemptNo}`;
    $("quizSubtitle").textContent = ""; // sin instrucciones adicionales

    const s = state.student;
    $("quizFooter").innerHTML = `<span class="strong">Nombre:</span> <span class="strong">${escapeHtml(s.name)}</span> · <span class="strong">Número de la lista:</span> ${escapeHtml(s.listNumber)} · Tiempo restante: <span class="strong">${fmtDuration(rem)}</span>`;

    const q = questions[qIndex];
    $("progressText").textContent = `Pregunta ${qIndex+1} de ${questions.length}`;
    $("qidText").textContent = q.id;
    $("qText").textContent = q.text;

    const opts = $("qOptions");
    opts.innerHTML = "";

    q.options.forEach((opt, oi) => {
      const optId = `${q.id}_${oi}`;
      const label = document.createElement("label");
      label.className = "opt";
      label.setAttribute("for", optId);

      label.innerHTML = `
        <input type="radio" name="opt" id="${optId}" />
        <div class="opt-text"><span class="opt-letter">${String.fromCharCode(65+oi)}.</span>${escapeHtml(opt.text)}</div>
      `;

      label.addEventListener("click", () => { selected[q.id] = oi; persistRuntime(); });

      const input = label.querySelector("input");
      input.addEventListener("change", () => { selected[q.id] = oi; persistRuntime(); });

      opts.appendChild(label);
    });

    if(selected[q.id] !== undefined){
      const oi = selected[q.id];
      const el = document.getElementById(`${q.id}_${oi}`);
      if(el) el.checked = true;
    }

    $("btnPrev").disabled = (qIndex === 0);
    const isLast = (qIndex === questions.length - 1);
    $("btnNext").classList.toggle("hidden", isLast);
    $("btnFinish").classList.toggle("hidden", !isLast);
  }

  function renderResults(){
    showOnly(viewResults);
    startTimer();
    setAttemptPill();

    const s = state.student;
    const hist = state.quiz.attemptHistory;
    const last = hist[hist.length-1];

    $("resultsTitle").textContent = "Resultados";
    $("resultsHeader").classList.remove("closed");
    $("resultsHeader").innerHTML = `
      <div><span class="strong">Nombre:</span> <span class="strong">${escapeHtml(s.name)}</span> · <span class="strong">Número de la lista:</span> ${escapeHtml(s.listNumber)}</div>
      <div style="margin-top:6px"><span class="strong">Intentos:</span> ${hist.length}/${MAX_ATTEMPTS} · <span class="strong">Nota válida (último intento):</span> ${last.percent}%</div>
    `;

    const tbody = $("resultsTable").querySelector("tbody");
    tbody.innerHTML = hist.map(r => `
      <tr>
        <td>${r.attemptNo}</td>
        <td>${r.score}/${r.total} (${r.percent}%)</td>
        <td>${fmtDuration(r.durationSec)}</td>
        <td>${escapeHtml(fmtDateTime(r.finishedAt))}</td>
      </tr>
    `).join("");

    const btns = $("resultsButtons");
    btns.innerHTML = "";

    const used = hist.length;
    const remAttempts = MAX_ATTEMPTS - used;
    const remTime = remainingGlobalSeconds();

    if(remAttempts > 0 && remTime > 0 && !state.closed){
      const b = document.createElement("button");
      b.className = "btn-primary";
      b.textContent = "Iniciar siguiente intento";
      b.addEventListener("click", () => startAttempt());
      btns.appendChild(b);
    } else {
      closeQuiz();
    }
  }

  // Events
  $("btnBack").addEventListener("click", () => showOnly(viewAccess));

  $("btnAccess").addEventListener("click", async () => {
    const code = ($("accessCode").value || "").trim();
    if(!code){ alert("Ingresa el código de acceso."); return; }
    const hash = await sha256Hex(code);
    if(hash !== ACCESS_CODE_SHA256){ alert("Código incorrecto."); return; }
    state.accessGranted = true;
    saveState(state);
    showOnly(viewInfo);
  });

  $("btnStart").addEventListener("click", () => {
    const nameRaw = ($("studentName").value || "").trim();
    const listNumber = ($("studentList").value || "").trim();
    if(!nameRaw || !listNumber){ alert("Completa nombre y número de la lista."); return; }

    // normalización: guardar en mayúsculas como lo pide el campo
    const name = nameRaw.toUpperCase();

    state.student = { name, listNumber };
    saveState(state);

    startGlobalTimerIfNeeded();
    startTimer();
    startAttempt();
  });

  $("btnPrev").addEventListener("click", () => {
    if(qIndex > 0){ qIndex -= 1; persistRuntime(); renderQuestion(); }
  });

  $("btnNext").addEventListener("click", () => {
    if(qIndex < questions.length - 1){ qIndex += 1; persistRuntime(); renderQuestion(); }
  });

  $("btnFinish").addEventListener("click", () => {
    const unanswered = questions.filter(q => selected[q.id] === undefined).length;
    if(unanswered > 0){
      const ok = confirm(`Te faltan ${unanswered} pregunta(s) por responder. ¿Finalizar de todos modos?`);
      if(!ok) return;
    }
    finalizeAttempt(false);
  });

  function init(){
    setAttemptPill();

    if(state.closed){
      startTimer();
      renderClosed();
      return;
    }

    if(state.quiz.endsAt && remainingGlobalSeconds() <= 0){
      closeQuiz();
      return;
    }

    if(state.accessGranted && state.student && state.student.name){
      startTimer();
      if(restoreRuntime()){
        showOnly(viewQuiz);
        renderQuestion();
        return;
      }
      if(state.quiz.attemptHistory && state.quiz.attemptHistory.length){
        renderResults();
        return;
      }
      showOnly(viewInfo);
      return;
    }

    showOnly(viewAccess);
  }

  init();
})();
</script>
</body>
</html>
